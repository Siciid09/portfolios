<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unified Admin Pro | Mubarik Osman</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: { 
                    colors: { 
                        brand: { accent: '#4f46e5', dark: '#0f172a', success: '#10b981', warning: '#f59e0b' } 
                    },
                    fontFamily: { sans: ['Outfit', 'sans-serif'] }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;700;900&display=swap" rel="stylesheet">
</head>
<body class="bg-slate-50 text-slate-800 font-sans antialiased h-screen overflow-hidden relative">

    <div class="flex h-full">
        
        <aside class="w-64 bg-brand-dark text-white flex flex-col shadow-2xl z-20 transition-all">
            <div class="h-20 flex items-center px-8 border-b border-white/10">
                <h2 class="text-xl font-bold tracking-tighter">MUBARIK<span class="text-brand-accent">.ADMIN</span></h2>
            </div>

            <nav class="flex-1 overflow-y-auto py-6 px-3 space-y-1">
                
                <p class="px-4 text-xs font-bold text-slate-500 uppercase tracking-wider mb-2 mt-2">Personal Brand</p>
                
                <button onclick="switchTab('profile')" class="nav-btn w-full text-left px-4 py-3 rounded-xl hover:bg-white/5 text-slate-300 hover:text-white transition-all flex items-center gap-3 group">
                    <span class="w-8 h-8 rounded-lg bg-indigo-500/10 text-indigo-400 flex items-center justify-center group-hover:bg-indigo-500 group-hover:text-white transition-colors"><i class="fa-solid fa-user text-sm"></i></span>
                    <span class="font-medium">Profile & Hero</span>
                </button>

                <button onclick="switchTab('services')" class="nav-btn w-full text-left px-4 py-3 rounded-xl hover:bg-white/5 text-slate-300 hover:text-white transition-all flex items-center gap-3 group">
                    <span class="w-8 h-8 rounded-lg bg-teal-500/10 text-teal-400 flex items-center justify-center group-hover:bg-teal-500 group-hover:text-white transition-colors"><i class="fa-solid fa-layer-group text-sm"></i></span>
                    <span class="font-medium">Strategic Solutions</span>
                </button>

                <button onclick="switchTab('experience')" class="nav-btn w-full text-left px-4 py-3 rounded-xl hover:bg-white/5 text-slate-300 hover:text-white transition-all flex items-center gap-3 group">
                    <span class="w-8 h-8 rounded-lg bg-purple-500/10 text-purple-400 flex items-center justify-center group-hover:bg-purple-500 group-hover:text-white transition-colors"><i class="fa-solid fa-road text-sm"></i></span>
                    <span class="font-medium">My Journey</span>
                </button>

                <div class="h-px bg-white/10 my-4 mx-4"></div>
                
                <p class="px-4 text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Portfolio Content</p>
                <button onclick="switchTab('projects')" class="nav-btn w-full text-left px-4 py-3 rounded-xl hover:bg-white/5 text-slate-300 hover:text-white transition-all flex items-center gap-3 group">
                    <span class="w-8 h-8 rounded-lg bg-blue-500/10 text-blue-400 flex items-center justify-center group-hover:bg-blue-500 group-hover:text-white transition-colors"><i class="fa-solid fa-briefcase text-sm"></i></span>
                    <span class="font-medium">Projects</span>
                </button>
                
                <button onclick="switchTab('skills')" class="nav-btn w-full text-left px-4 py-3 rounded-xl hover:bg-white/5 text-slate-300 hover:text-white transition-all flex items-center gap-3 group">
                    <span class="w-8 h-8 rounded-lg bg-orange-500/10 text-orange-400 flex items-center justify-center group-hover:bg-orange-500 group-hover:text-white transition-colors"><i class="fa-solid fa-bolt text-sm"></i></span>
                    <span class="font-medium">Skills</span>
                </button>
                
                <button onclick="switchTab('certificates')" class="nav-btn w-full text-left px-4 py-3 rounded-xl hover:bg-white/5 text-slate-300 hover:text-white transition-all flex items-center gap-3 group">
                    <span class="w-8 h-8 rounded-lg bg-yellow-500/10 text-yellow-400 flex items-center justify-center group-hover:bg-yellow-500 group-hover:text-white transition-colors"><i class="fa-solid fa-certificate text-sm"></i></span>
                    <span class="font-medium">Certificates</span>
                </button>

                <div class="h-px bg-white/10 my-4 mx-4"></div>
                
                <p class="px-4 text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Analytics</p>
                <button onclick="switchTab('surveys')" class="nav-btn w-full text-left px-4 py-3 rounded-xl hover:bg-white/5 text-slate-300 hover:text-white transition-all flex items-center gap-3 group">
                    <span class="w-8 h-8 rounded-lg bg-green-500/10 text-green-400 flex items-center justify-center group-hover:bg-green-500 group-hover:text-white transition-colors"><i class="fa-solid fa-chart-pie text-sm"></i></span>
                    <span class="font-medium">Survey Data</span>
                </button>
                <button onclick="switchTab('messages')" class="nav-btn w-full text-left px-4 py-3 rounded-xl hover:bg-white/5 text-slate-300 hover:text-white transition-all flex items-center gap-3 group">
                    <span class="w-8 h-8 rounded-lg bg-pink-500/10 text-pink-400 flex items-center justify-center group-hover:bg-pink-500 group-hover:text-white transition-colors"><i class="fa-solid fa-envelope text-sm"></i></span>
                    <span class="font-medium">Messages</span>
                </button>
            </nav>
            
            <div class="p-4 border-t border-white/10 bg-black/20">
                <a href="index.html" class="flex items-center gap-3 text-sm text-slate-400 hover:text-white transition-colors">
                    <i class="fa-solid fa-arrow-right-from-bracket"></i> Back to Website
                </a>
            </div>
        </aside>

        <main class="flex-1 overflow-y-auto relative bg-slate-50">
            <header class="sticky top-0 bg-white/80 backdrop-blur-md border-b border-slate-200 z-10 px-8 py-4 flex justify-between items-center">
                <h1 id="page-title" class="text-2xl font-bold text-slate-800">Dashboard</h1>
                <div class="text-sm text-slate-500" id="current-date"></div>
            </header>

            <div class="p-8 max-w-7xl mx-auto min-h-[calc(100vh-80px)]">
                
                <div id="tab-profile" class="tab-content hidden">
                    <div class="bg-white p-8 rounded-2xl shadow-sm border border-slate-200">
                        <div class="flex items-center justify-between mb-8">
                            <h2 class="text-2xl font-bold text-slate-800">Profile & Hero Settings</h2>
                            <span class="text-xs font-bold bg-brand-accent/10 text-brand-accent px-3 py-1 rounded-full">LIVE CONTENT</span>
                        </div>
                        
                        <form onsubmit="handleProfileSave(event)" class="space-y-6 max-w-3xl">
                            <div class="bg-slate-50 p-6 rounded-xl border border-slate-200">
                                <label class="block text-sm font-bold text-slate-700 mb-4">Main Profile Image</label>
                                <div class="flex flex-col md:flex-row gap-6 items-start">
                                    <div class="w-32 h-32 bg-slate-200 rounded-2xl overflow-hidden flex-shrink-0 border-2 border-white shadow-lg">
                                        <img id="preview-hero" src="https://via.placeholder.com/150" class="w-full h-full object-cover">
                                    </div>
                                    <div class="flex-1 w-full space-y-4">
                                        <div>
                                            <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Option A: Upload File</label>
                                            <input type="file" id="profile-file" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100 cursor-pointer border border-slate-200 rounded-lg p-2" accept="image/*">
                                        </div>
                                        <div class="relative">
                                            <div class="absolute inset-0 flex items-center">
                                                <div class="w-full border-t border-slate-200"></div>
                                            </div>
                                            <div class="relative flex justify-center text-xs uppercase">
                                                <span class="bg-slate-50 px-2 text-slate-400 font-bold">OR</span>
                                            </div>
                                        </div>
                                        <div>
                                            <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Option B: Image Link</label>
                                            <input type="text" id="profile-url" name="imgUrl" placeholder="https://example.com/my-photo.jpg" class="input-std">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label class="block text-sm font-bold text-slate-700 mb-2">Full Name</label>
                                    <input type="text" id="profile-name" name="name" class="input-std" placeholder="Mubarik Osman">
                                </div>
                                <div>
                                    <label class="block text-sm font-bold text-slate-700 mb-2">Tagline (Typewriter Text)</label>
                                    <input type="text" id="profile-titles" name="titles" class="input-std" placeholder="Engineer, Strategist, Designer">
                                    <p class="text-xs text-slate-400 mt-1">Separate with commas</p>
                                </div>
                                <div class="md:col-span-2">
                                    <label class="block text-sm font-bold text-slate-700 mb-2">Bio / Description</label>
                                    <textarea id="profile-bio" name="bio" class="input-std h-32 resize-none" placeholder="I solve complex business problems..."></textarea>
                                </div>
                            </div>

                            <button type="submit" class="btn-primary py-4 text-lg">Save Profile Settings</button>
                        </form>
                    </div>
                </div>

                <div id="tab-projects" class="tab-content hidden">
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 mb-8">
                        <h3 class="font-bold text-lg mb-4 text-slate-800">Add New Project</h3>
                        <form onsubmit="handleCreate(event, 'projects')" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <input type="text" name="title" placeholder="Project Title" class="input-std" required>
                            <input type="text" name="type" placeholder="Type (SaaS, App)" class="input-std" required>
                            
                            <div class="md:col-span-2 bg-slate-50 p-4 rounded-xl border border-slate-200">
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Project Image (Upload OR Link)</label>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <input type="file" id="project-file" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100 cursor-pointer border border-slate-200 rounded-lg p-2" accept="image/*">
                                    <input type="text" name="imgUrl" placeholder="Paste Image URL here..." class="input-std">
                                </div>
                            </div>

                            <input type="text" name="desc" placeholder="Short Description" class="input-std md:col-span-2" required>
                            <button type="submit" class="btn-primary md:col-span-2">Publish Project</button>
                        </form>
                    </div>
                    <div id="list-projects" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                </div>

                <div id="tab-services" class="tab-content hidden">
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 mb-8">
                        <h3 class="font-bold text-lg mb-4 text-slate-800">Add Strategic Solution</h3>
                        <form onsubmit="handleCreate(event, 'services')" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <input type="text" name="title" placeholder="Service Title" class="input-std" required>
                            <input type="text" name="icon" placeholder="Icon Class (fa-solid fa-code)" class="input-std" required>
                            <input type="text" name="desc" placeholder="Description" class="input-std md:col-span-2" required>
                            <button type="submit" class="btn-primary md:col-span-2">Add Solution</button>
                        </form>
                    </div>
                    <div id="list-services" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                </div>

                <div id="tab-experience" class="tab-content hidden">
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 mb-8">
                        <h3 class="font-bold text-lg mb-4 text-slate-800">Add Journey Milestone</h3>
                        <form onsubmit="handleCreate(event, 'experience')" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <input type="text" name="year" placeholder="Year / Duration" class="input-std" required>
                            <input type="text" name="title" placeholder="Job Title" class="input-std" required>
                            <input type="text" name="company" placeholder="Company / Organization" class="input-std" required>
                            <input type="text" name="desc" placeholder="Role Description" class="input-std md:col-span-2" required>
                            <button type="submit" class="btn-primary md:col-span-2">Add Milestone</button>
                        </form>
                    </div>
                    <div id="list-experience" class="space-y-4"></div>
                </div>

                <div id="tab-certificates" class="tab-content hidden">
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 mb-8">
                        <h3 class="font-bold text-lg mb-4 text-slate-800">Add Certificate</h3>
                        <form onsubmit="handleCreate(event, 'certificates')" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <input type="text" name="title" placeholder="Certificate Title" class="input-std" required>
                            
                            <div class="md:col-span-1">
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Image (Upload OR Link)</label>
                                <input type="file" id="cert-file" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-yellow-50 file:text-yellow-700 hover:file:bg-yellow-100 cursor-pointer border border-slate-200 rounded-lg p-2 mb-2" accept="image/*">
                                <input type="text" name="imgUrl" placeholder="Or paste URL..." class="input-std text-xs">
                            </div>

                            <input type="text" name="desc" placeholder="Description" class="input-std md:col-span-2" required>
                            <button type="submit" class="btn-primary md:col-span-2">Add Cert</button>
                        </form>
                    </div>
                    <div id="list-certificates" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
                </div>

                <div id="tab-skills" class="tab-content hidden">
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 mb-8">
                        <h3 class="font-bold text-lg mb-4 text-slate-800">Add Skill</h3>
                        <form onsubmit="handleCreate(event, 'skills')" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <input type="text" name="name" placeholder="Skill Name" class="input-std" required>
                            <select name="cat" class="input-std" required>
                                <option value="frontend">Frontend</option>
                                <option value="backend">Backend</option>
                                <option value="design">Design</option>
                                <option value="soft">Soft Skill</option>
                            </select>
                            <input type="text" name="icon" placeholder="Icon (fa-brands fa-react)" class="input-std" required>
                            <button type="submit" class="btn-primary md:col-span-3">Add Skill</button>
                        </form>
                    </div>
                    <div id="list-skills" class="flex flex-wrap gap-3"></div>
                </div>

                <div id="tab-surveys" class="tab-content hidden">
                    <h2 class="text-xl font-bold text-slate-800 mb-4">Survey Analytics</h2>
                    <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full text-left text-sm">
                                <thead class="bg-slate-50 text-slate-500 uppercase text-xs font-bold border-b">
                                    <tr><th class="p-4">Time</th><th class="p-4">Name</th><th class="p-4">Device</th><th class="p-4">Price</th></tr>
                                </thead>
                                <tbody id="surveyTableBody" class="divide-y divide-slate-100"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <div id="tab-messages" class="tab-content hidden">
                    <div id="list-messages" class="grid grid-cols-1 gap-4"></div>
                </div>

            </div>
        </main>
    </div>

    <div id="editModal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/60 backdrop-blur-sm opacity-0 transition-opacity duration-300">
        <div class="bg-white w-full max-w-lg rounded-2xl p-6 shadow-2xl transform scale-95 transition-transform duration-300">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-slate-800">Edit Item</h3>
                <button onclick="closeEditModal()" class="w-8 h-8 rounded-full bg-slate-100 hover:bg-slate-200 flex items-center justify-center"><i class="fa-solid fa-xmark"></i></button>
            </div>
            
            <form id="editForm" onsubmit="handleUpdate(event)">
                <input type="hidden" name="docId" id="edit-docId">
                <input type="hidden" name="collectionName" id="edit-collectionName">
                <input type="hidden" name="existingImage" id="edit-existingImage">
                
                <div id="edit-fields" class="space-y-4 max-h-[60vh] overflow-y-auto pr-2">
                    </div>
                
                <div class="mt-6 pt-4 border-t border-slate-100">
                    <button type="submit" class="w-full bg-brand-accent hover:bg-indigo-700 text-white font-bold py-3 rounded-xl transition-colors shadow-lg shadow-indigo-500/30">
                        Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>

    <style>
        .input-std { width: 100%; padding: 0.75rem 1rem; border-radius: 0.75rem; border: 1px solid #e2e8f0; background-color: #f8fafc; font-size: 0.875rem; outline: none; transition: all 0.2s; }
        .input-std:focus { border-color: #4f46e5; background-color: #fff; box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1); }
        .btn-primary { width: 100%; background-color: #4f46e5; color: white; padding: 0.75rem; border-radius: 0.75rem; font-weight: 700; transition: all 0.2s; box-shadow: 0 4px 6px -1px rgba(79, 70, 229, 0.2); }
        .btn-primary:hover { background-color: #4338ca; transform: translateY(-1px); }
        .nav-btn.active { background-color: rgba(255,255,255,0.1); color: white; border-left: 3px solid #4f46e5; }
        aside ::-webkit-scrollbar { width: 4px; }
        aside ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 10px; }
    </style>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, updateDoc, query, orderBy, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyC7dQr5Ub5LP-UUq30N6Sn7X1JB_AZFLcQ",
            authDomain: "portfalio1.firebaseapp.com",
            projectId: "portfalio1",
            storageBucket: "portfalio1.firebasestorage.app",
            messagingSenderId: "806539469974",
            appId: "1:806539469974:web:368f1711bdd2d09a5f8eb7",
            measurementId: "G-CGFDMTH1N8"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);

        document.getElementById('current-date').textContent = new Date().toLocaleDateString();

        // --- IMAGE HELPER: Checks Upload -> Checks URL -> Returns final URL ---
        async function getFinalImageUrl(fileInputId, urlInputName, formData) {
            // 1. Check for File Upload
            if (fileInputId) {
                const fileInput = document.getElementById(fileInputId);
                if (fileInput && fileInput.files[0]) {
                    const file = fileInput.files[0];
                    const storageRef = ref(storage, `uploads/${Date.now()}_${file.name}`);
                    await uploadBytes(storageRef, file);
                    return await getDownloadURL(storageRef);
                }
            }
            // 2. Check for Text URL
            if (formData && formData.get(urlInputName)) {
                const url = formData.get(urlInputName).trim();
                if(url) return url;
            }
            return null;
        }

        // --- NAVIGATION & INIT ---
        window.switchTab = (tabName) => {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
            
            const target = document.getElementById(`tab-${tabName}`);
            if(target) target.classList.remove('hidden');
            
            // Highlight Button
            const btns = document.querySelectorAll('.nav-btn');
            btns.forEach(b => { 
                // Simple keyword matching for styling
                const txt = b.innerText.toLowerCase();
                if(txt.includes(tabName) || (tabName === 'profile' && txt.includes('profile')) || (tabName === 'services' && txt.includes('strategic'))) {
                    b.classList.add('active'); 
                }
            });

            document.getElementById('page-title').textContent = tabName.charAt(0).toUpperCase() + tabName.slice(1);
            
            if (tabName === 'surveys') loadSurveys();
            else if (tabName === 'profile') loadProfile();
            else loadCollectionData(tabName);
        }

        // --- PROFILE LOGIC ---
        async function loadProfile() {
            try {
                const docRef = doc(db, "profile", "main");
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    document.getElementById('profile-name').value = data.name || '';
                    document.getElementById('profile-titles').value = data.titles || '';
                    document.getElementById('profile-bio').value = data.bio || '';
                    document.getElementById('profile-url').value = data.img || '';
                    document.getElementById('preview-hero').src = data.img || 'https://via.placeholder.com/150';
                }
            } catch(e) { console.error("Profile Load Error", e); }
        }

        window.handleProfileSave = async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Saving...';
            btn.disabled = true;

            try {
                const formData = new FormData(e.target);
                const updates = Object.fromEntries(formData.entries());
                
                // Handle Dual Image Input
                const newImg = await getFinalImageUrl('profile-file', 'imgUrl', formData);
                if(newImg) updates.img = newImg;

                await setDoc(doc(db, "profile", "main"), updates, { merge: true });
                alert("Profile Updated Successfully!");
                loadProfile(); // refresh view
            } catch (error) {
                alert("Error: " + error.message);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        };

        // --- CREATE ITEM (Generic) ---
        window.handleCreate = async (e, collectionName) => {
            e.preventDefault();
            const btn = e.target.querySelector('button');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Saving...';
            btn.disabled = true;

            try {
                const formData = new FormData(e.target);
                const data = Object.fromEntries(formData.entries());
                
                // Determine File ID
                let fileInputId = null;
                if(collectionName === 'projects') fileInputId = 'project-file';
                if(collectionName === 'certificates') fileInputId = 'cert-file';

                const finalImg = await getFinalImageUrl(fileInputId, 'imgUrl', formData);
                if(finalImg) data.img = finalImg;

                // Defaults
                if(collectionName === 'services') { data.from = '#4f46e5'; data.to = '#8b5cf6'; }
                if(collectionName === 'messages') data.timestamp = new Date();

                await addDoc(collection(db, collectionName), data);
                e.target.reset();
                if(fileInputId) document.getElementById(fileInputId).value = ""; 
                loadCollectionData(collectionName);
                
            } catch (error) {
                alert("Error: " + error.message);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        };

        // --- READ LIST ---
        async function loadCollectionData(colName) {
            const container = document.getElementById(`list-${colName}`);
            if(!container) return;
            container.innerHTML = '<div class="col-span-full py-12 text-center"><i class="fa-solid fa-circle-notch fa-spin text-3xl text-brand-accent"></i></div>';

            try {
                let q = collection(db, colName);
                if(colName === 'messages') q = query(collection(db, colName), orderBy('timestamp', 'desc'));
                
                const querySnapshot = await getDocs(q);
                container.innerHTML = '';

                if (querySnapshot.empty) {
                    container.innerHTML = `<div class="col-span-full text-center py-10 border border-dashed border-slate-300 rounded-xl text-slate-400">No items found.</div>`;
                    return;
                }

                querySnapshot.forEach((doc) => {
                    const html = generateCardHTML(colName, doc.data(), doc.id);
                    container.insertAdjacentHTML('beforeend', html);
                });
            } catch (e) {
                container.innerHTML = `<p class="text-red-500 col-span-full">Error: ${e.message}</p>`;
            }
        }

        function generateCardHTML(type, data, id) {
            const imgSrc = data.img || data.image || data.url || 'https://via.placeholder.com/400';
            const actions = `
                <div class="absolute top-3 right-3 flex gap-2 z-10">
                    <button onclick='window.prepareEdit("${type}", "${id}", ${JSON.stringify(data).replace(/'/g, "&#39;")})' class="w-8 h-8 bg-white/90 hover:bg-indigo-50 text-indigo-500 rounded-lg shadow-sm border border-indigo-100 flex items-center justify-center transition-all"><i class="fa-solid fa-pen text-xs"></i></button>
                    <button onclick="deleteItem('${type}', '${id}')" class="w-8 h-8 bg-white/90 hover:bg-red-50 text-red-500 rounded-lg shadow-sm border border-red-100 flex items-center justify-center transition-all"><i class="fa-solid fa-trash text-xs"></i></button>
                </div>`;

            if (type === 'projects' || type === 'certificates') {
                return `
                    <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden relative group hover:shadow-md transition-all">
                        ${actions}
                        <div class="h-40 bg-slate-100 overflow-hidden relative">
                            <img src="${imgSrc}" class="w-full h-full object-cover">
                        </div>
                        <div class="p-5">
                            <h4 class="font-bold text-lg text-slate-800 mb-1 line-clamp-1">${data.title}</h4>
                            <p class="text-xs text-slate-500 line-clamp-2">${data.desc}</p>
                        </div>
                    </div>`;
            }

            if (type === 'experience') {
                return `
                    <div class="bg-white p-5 rounded-xl border border-slate-200 relative group hover:border-purple-500/30 transition-all">
                        ${actions}
                        <div class="pl-4 border-l-2 border-brand-accent">
                            <span class="text-xs font-bold bg-slate-100 px-2 py-1 rounded text-slate-500">${data.year}</span>
                            <h4 class="font-bold text-lg mt-2">${data.title}</h4>
                            <p class="text-sm font-semibold text-brand-accent">${data.company}</p>
                            <p class="text-xs text-slate-500 mt-2">${data.desc}</p>
                        </div>
                    </div>`;
            }

            // Default fallback
            return `
                <div class="bg-white p-4 rounded-xl border border-slate-200 relative group">
                    ${actions}
                    <h4 class="font-bold text-sm mb-1">${data.title || data.name}</h4>
                    <p class="text-xs text-slate-500 truncate">${data.desc || data.cat || '-'}</p>
                </div>`;
        }

        // --- DELETE ---
        window.deleteItem = async (collectionName, id) => {
            if(confirm("Are you sure?")) {
                try { await deleteDoc(doc(db, collectionName, id)); loadCollectionData(collectionName); } 
                catch(e) { alert("Error: " + e.message); }
            }
        }

        // --- EDIT LOGIC (Dynamic Form) ---
        window.prepareEdit = (collectionName, id, data) => {
            const modal = document.getElementById('editModal');
            const fieldsContainer = document.getElementById('edit-fields');
            
            document.getElementById('edit-docId').value = id;
            document.getElementById('edit-collectionName').value = collectionName;
            document.getElementById('edit-existingImage').value = data.img || data.image || '';

            fieldsContainer.innerHTML = ''; 

            // Build Fields
            Object.keys(data).forEach(key => {
                if(key !== 'timestamp' && key !== 'img' && key !== 'image') {
                    const div = document.createElement('div');
                    div.innerHTML = `
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">${key}</label>
                        <input type="text" name="${key}" value="${data[key] || ''}" class="input-std">
                    `;
                    fieldsContainer.appendChild(div);
                }
            });

            // Image Edit Field
            if(['projects', 'certificates'].includes(collectionName)) {
                const imgDiv = document.createElement('div');
                imgDiv.innerHTML = `
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Update Image</label>
                    <div class="space-y-3 bg-slate-50 p-3 rounded-lg border border-slate-200">
                         <div class="flex items-center gap-3">
                            <img src="${data.img || ''}" class="w-10 h-10 rounded object-cover border">
                            <span class="text-xs text-slate-400">Current</span>
                         </div>
                         <input type="file" id="edit-file" name="newImageFile" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100 cursor-pointer">
                         <div class="text-center text-xs text-slate-400 font-bold uppercase">- OR -</div>
                         <input type="text" name="imgUrl" placeholder="New Image URL" class="input-std text-xs" value="${data.img && data.img.startsWith('http') && !data.img.includes('firebasestorage') ? data.img : ''}">
                    </div>
                `;
                fieldsContainer.appendChild(imgDiv);
            }

            modal.classList.remove('hidden');
            setTimeout(() => modal.classList.remove('opacity-0'), 10);
            modal.querySelector('div').classList.remove('scale-95');
            modal.querySelector('div').classList.add('scale-100');
        };

        window.closeEditModal = () => {
            const modal = document.getElementById('editModal');
            modal.classList.add('opacity-0');
            setTimeout(() => modal.classList.add('hidden'), 300);
        };

        window.handleUpdate = async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Saving...';
            btn.disabled = true;

            try {
                const formData = new FormData(e.target);
                const docId = formData.get('docId');
                const colName = formData.get('collectionName');
                const updates = {};

                for(let [key, value] of formData.entries()) {
                    if(!['docId','collectionName','existingImage','newImageFile','imgUrl'].includes(key)) updates[key] = value;
                }

                // Handle Image Update
                const newImg = await getFinalImageUrl('edit-file', 'imgUrl', formData);
                if(newImg) updates.img = newImg;

                await updateDoc(doc(db, colName, docId), updates);
                closeEditModal();
                loadCollectionData(colName);
            } catch(error) {
                alert("Update failed: " + error.message);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        };

        async function loadSurveys() {
            const tbody = document.getElementById('surveyTableBody');
            tbody.innerHTML = '<tr><td colspan="4" class="p-4 text-center">Loading...</td></tr>';
            try {
                const s = await getDocs(query(collection(db, "app_surveys"), orderBy("timestamp", "desc")));
                tbody.innerHTML = s.docs.map(d => {
                    const data = d.data();
                    return `<tr class="border-b"><td class="p-4 text-xs">${data.timestamp?.toDate().toLocaleDateString()}</td><td class="p-4 font-bold">${data.name||'-'}</td><td class="p-4 text-xs">${data.device}</td><td class="p-4 text-green-600 font-bold">${data.price}</td></tr>`;
                }).join('');
            } catch(e) { tbody.innerHTML = '<tr><td colspan="4" class="p-4 text-red-500">Error loading data</td></tr>'; }
        }

        // Init
        switchTab('profile'); // Open Profile tab by default

    </script>
</body>
</html>
